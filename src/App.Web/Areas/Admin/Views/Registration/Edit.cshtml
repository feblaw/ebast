@using App.Web.Models.ViewModels.Core.Business
@model AttendaceExceptionListModelForm

@{
    ViewBag.Title = "Activity Registration | Edit";
    var Weeks = JsonConvert.DeserializeObject(ViewBag.Weeks);
    var Dates = JsonConvert.DeserializeObject(ViewBag.Dates);
   
}

@section breadcrumb{
    <li>
        <a href="@Url.Action("Index")">Activity Registration List</a>

        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span>Create</span>
    </li>
}

<h1 class="page-title">Activity Registration <small>Create</small></h1>
<div class="portlet light portlet-fit portlet-form bordered">
    <div class="portlet-title">
        <div class="caption">
            <span class="caption-subject font-blue sbold uppercase">Activity Form</span>
        </div>
        <div class="pull-right">
            <a class="btn btn-default" href="@Url.Action("Index")"><i class="fa fa-arrow-circle-left"></i> Return to index</a>
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="portlet-body">
        <form role="form" asp-action="Edit" method="post" id="form" class="form-horizontal">
            <div class="form-body">
                <div class="alert alert-danger display-hide">
                    <button class="close" data-close="alert"></button> You have some form errors. Please check below.
                </div>
                @Html.ValidationSummary(true, "Failed to submit", new { @class = "alert alert-danger" })

                <div class="form-group">
                    <label asp-for="DepartmentId" class="control-label col-md-3">
                        Organizational Unit
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="DepartmentId" asp-items="@(new SelectList(@ViewBag.OrganizationUnit, "Id","Name"))" required>
                            <option disabled selected>-- Select Organizational Unit --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>
                <div class="form-group">
                    <label asp-for="DepartmentSubId" class="control-label col-md-3">
                        Sub Organizational Unit
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="DepartmentSubId" required>
                            <option disabled selected>-- Select Sub Organizational Unit --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>
                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Cost Center
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="CostId" required>
                            <option disabled selected>-- Select Cost Center --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Account Name
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="AccountNameId" asp-items="@(new SelectList(@ViewBag.AccountName, "Id","Name"))" required>
                            <option disabled selected>-- Select Account Name --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Network / Other Assignment
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="NetworkId" required>
                            <option disabled selected>-- Select Network / Other Assignment --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Project
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="ProjectId" asp-items="@(new SelectList(@ViewBag.Project, "Id","Name"))" required>
                            <option disabled selected>-- Select Project --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Activity
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="ActivityId" asp-items="@(new SelectList(@ViewBag.Activity, "Id","DisplayName"))" required>
                            <option disabled selected>-- Select Activity --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Sub Operation
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="SubOpsId" asp-items="@(new SelectList(@ViewBag.SubOperasional, "Id","Code"))" required>
                            <option disabled selected>-- Select Sub Operation --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Location
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="LocationId" asp-items="@(new SelectList(@ViewBag.City, "Id","Name"))" required>
                            <option disabled selected>-- Select Location --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Time Sheet Type
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="TimeSheetTypeId" asp-items="@(new SelectList(@ViewBag.TimeSheetType, "Id", "Type"))" required>
                            <option disabled selected>-- Select Time Sheet Type --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group regular">
                    <label asp-for="Description" class="control-label col-md-3">
                        Time Sheet Period
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        @*<select class="form-control" asp-for="Code" required>
                    <option disabled selected>-- Select Time Sheet Period --</option>
                </select>*@
                        <select class="form-control" id="TimeSheetPeriod" asp-items="@(new SelectList(Weeks, "Weeks","SelectDates"))" style="width:100%;">
                            <option disabled selected>-- Select Time Sheet Period --</option>
                        </select>

                    </div>
                </div>

                <div class="form-group regular">
                    <div class="col-md-3"></div>
                    <div class="col-md-6">
                        <div class="form-control regular" style="border:0px solid white">
                            <div id="TimeSheetDate">
                                @foreach (var item in Dates)
                                {
                                    if (item.Weeks == Weeks.Count)
                                    {
                                        <div class="text-center" style="width:110px; float:left; margin-bottom:20px;margin-right:10px">
                                            <div class="form-control" style="background-color:#4480ac; border:1px solid #4480ac; color:white">@item.Date.ToString("yyyy-MM-dd")</div>
                                            <input type="number" class="form-control numeric" placeholder="hours" />
                                            <span>@item.DateName</span>
                                        </div>
                                    }

                                }
                            </div>
                            <div class="clearfix"></div>
                            <div class="margin-top-10">Total Hours:</div>
                            <span id="TotalHour">0</span>
                            <input type="hidden" asp-for="Hours" />
                            <input type="hidden" asp-for="AttendanceRecordDate"/>
                        </div>
                    </div>
                </div>

                <div class="clearfix"></div>
                
                <table border="0" width="100%">
                    <tr>
                        <td class="col-md-9 annual">
                            <div class="form-group no-margin">
                                <label asp-for="DateStart" class="control-label col-md-4" id="DateFirst">
                                    Start Date
                                    <span class="text-danger"> * </span>
                                </label>
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control form_datetime" id="DateStartView" value="@Model.DateStart.ToString("dd MMMM yyyy")" readonly />
                                        <span class="input-group-btn">
                                            <button class="btn btn-secondary" type="button"><i class="fa fa-calendar"></i></button>
                                        </span>
                                    </div>
                                    <input type="hidden" class="form-control" asp-for="DateStart" readonly required />
                                    <span asp-validation-for="DateStart" class="text-danger DateValid"></span>
                                </div>
                            </div>
                        </td>
                        <td rowspan="2" class="annual" valign="middle" width="20px" style="border-left: dotted 1px #000000"> <i class="fa fa-caret-right fa-3x font-green-dark" style="margin-right: 0px !important; padding-right: 0px !important"></i></td>
                        <td rowspan="2" class="annual" valign="middle"><span>Max @ViewBag.Annual Days</span></td>
                    </tr>
                    <tr>
                        <td class="col-md-9 annual">
                            <div class="form-group no-margin margin-top-10">
                                <label asp-for="DateEnd" class="control-label col-md-4" id="DateLast">
                                    End Date
                                    <span class="text-danger"> * </span>
                                </label>
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control form_datetime" id="DateEndView" value="@Model.DateEnd.ToString("dd MMMM yyyy")" readonly />
                                        <span class="input-group-btn">
                                            <button class="btn btn-secondary" type="button"><i class="fa fa-calendar"></i></button>
                                        </span>
                                    </div>
                                    <input type="hidden" class="form-control" asp-for="DateEnd" readonly required />
                                    <span asp-validation-for="DateEnd" class="text-danger DateValid"></span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>

                <div class="clearfix"></div>
                <div class="form-group annual">
                    <label class="control-label col-md-3">
                        Total Day
                    </label>
                    <div class="col-md-9">
                        <p class="form-control-static">
                            <strong id="total_day"></strong>
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Description
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <textarea rows="3" class="form-control" asp-for="Description"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Project Manager
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="ApproverOneId" asp-items="@(new SelectList(@ViewBag.ProjectManager, "Id","Name"))" required>
                            <option disabled selected>-- Select Project Manager --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="control-label col-md-3">
                        Line Manager
                        <span class="text-danger"> * </span>
                    </label>
                    <div class="col-md-6">
                        <select class="form-control" asp-for="ApproverTwoId" asp-items="@(new SelectList(@ViewBag.LineManager, "Id","Name"))" required>
                            <option disabled selected>-- Select Line Manager --</option>
                        </select>
                        @*<select class="form-control" asp-for="" asp-items="@(new SelectList(@ViewBag., "Id","Name"))" required></select>*@
                    </div>
                </div>
                <div class="form-group last">
                    <div class="col-md-3 col-md-offset-3">
                        <label class="text-danger">* Field Required</label>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <div class="row">
                    <div class="col-md-3 col-md-offset-3">
                        <input type="hidden" asp-for="DateStart" required />
                        <input type="hidden" asp-for="DateEnd" required />
                        <a asp-action="Index" class="btn btn-default"><i class="fa fa-arrow-left"></i>&nbsp; Back</a>
                        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i>&nbsp; Save</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/assets/pages/scripts/role/form-validation.js"></script>
    <script>
        $(document).ready(function () {
            $common.setMenu("#menu-registation", "#menu-registation");
            $('select').select2();
            $('#DepartmentId').trigger('change');
            FormValidation.init("#form");


            $(".form_datetime").datepicker({
                autoclose: true,
                format: "dd MM yyyy",
            });

            $('#DateStartView').change(function () {
                var value = $(this).val();
                var val = my_date.date_to_db(value);
                var DateEnd = $('#DateEnd').val();
                $('#DateStart').val(val);
                var timedate = $("#TimeSheetTypeId option:selected").text();
                var result = timedate.toString().toLowerCase().replace(" ", "");
                if (result == "annualleave") {
                    ValidDate(val, DateEnd);
                }
            });
            $('#DateStartView').trigger('change');

            $('#DateEndView').change(function () {
                var value = $(this).val();
                var val = my_date.date_to_db(value);
                var DateStart = $('#DateStart').val();
                $('#DateEnd').val(val);
                var timedate = $("#TimeSheetTypeId option:selected").text();
                var result = timedate.toString().toLowerCase().replace(" ", "");
                if (result == "annualleave") {
                    ValidDate(DateStart, val)
                }
            });
            $('#DateEndView').trigger('change');

        });

        var dates = JSON.parse('@Html.Raw(ViewBag.Dates)');
       


        $("#TimeSheetPeriod").change(function () {
            var val = $(this).val();
            var input = val.split(";");
            var html = '';
            var TotalHours = 0;
            var ArrDate = new Array();
            for (i = 0; i < dates.length-1; i++) {
                if (dates[i].Weeks == parseInt(input[2])) {
                    html += '<div class="text-center" style="width:150px; float:left; margin-bottom:20px;margin-right:10px">' +
                        '<div class="form-control" style="background-color:#4480ac; border:1px solid #4480ac; color:white">' + moment(dates[i].Date).format("DD MMMM YYYY") + '</div>' +
                        '<input type="number" class="form-control numeric" value="" asp-for="Description" placeholder="hours" />' +
                        '<span>' + dates[i].DateName + '</span>' +
                    '</div>';
                    ArrDate.push(moment(dates[i].Date).format("YYYY-MM-DD"));
                }
            }
            $('#TimeSheetDate').empty();
            $('#TimeSheetDate').append(html);
            $("#TotalHour").text(0);
            $("input[name=DateStart]").val(input[0]);
            $("input[name=DateEnd]").val(input[1]);
            $('#AttendanceRecordDate').val(ArrDate);
        });

       
        $(document).on("change", ".numeric", function () {
            var sum = 0;
            var Hours = new Array();
            $(".numeric").each(function (i) {
                sum += +$(this).val();
                Hours[i] = $(this).val();
            });
            $("#TotalHour").text(sum.toString());
            $('#Hours').val(Hours);
        });

        $('#DepartmentId').change(function () {
            var val = $(this).val();
            $.ajax({
                url: "/Admin/Api/Vacancy/GetSubdivision?id=" + val, success: function (result) {
                    $('#DepartmentSubId').html(result.subdivision);
                    $('#CostId').html(result.costCenter);
                    $('#NetworkId').html(result.network);
                    $('#DepartmentSubId').val('@Model.DepartmentSubId');
                    $('#CostId').val('@Model.CostId');
                    $('#NetworkId').val('@Model.NetworkId');

                }
            });
        });

       

        $('#TimeSheetTypeId').change(function () {
            var val = $("#TimeSheetTypeId option:selected").text();
            var result = val.toString().toLowerCase().replace(" ", "");
            if (result == "annualleave") {
                $('.annual').show();
                $('.regular').hide();
            } else {
                $('.regular').show();
                $('.annual').hide();
            }
        });


        $('#ApproverOneId').change(function () {
            var val = $(this).val();
            $('#ApproverTwoId').val(val).trigger('change');
        });

        $("#TimeSheetPeriod").val('@ViewBag.TimeSelected').trigger('change');
        $('#TimeSheetTypeId').trigger('change');

        var InputHours = $('#Hours').val().split(",");
        var Tot = 0;
        $('.numeric').each(function (i) {
            $(this).val(InputHours[i]);
            Tot += parseInt(InputHours[i]);
        });
        $("#TotalHour").text(Tot);

        function ValidDate(DateFirst, DateEnd) {
            $.ajax({
                url: "/Admin/Api/Registration/CheckingDate?DateFirst=" + DateFirst + "&DateLast=" + DateEnd + "&id=@ViewBag.Id", success: function (result) {
                    $('#total_day').text(result.total_day + " Days");
                    if (result.message == false) {
                        if (DateFirst == '' || DateEnd == '') {
                            $('.DateValid').text("Date cannot be empty !!");
                        } else {
                            var annual = parseInt(result.annual);
                            var total_day = parseInt(result.total_day);
                            if (annual == 0) {
                                $('.DateValid').text("Annual Leave is Expired");
                            } else if (total_day <= 0) {
                                $('.DateValid').text("Days must be more than 1 Days !!");
                            } else if (total_day > annual) {
                                $('.DateValid').text("Maximum days must under " + annual + " Days !!");
                            } else {
                                $('.DateValid').text("Date period are exists !!");
                            }

                        }
                        $('.DateValid').attr("aria-invalid", "true");
                        $('.DateValid').closest('.form-group').addClass('has-error');
                    }
                    else {
                        $('.DateValid').text("");
                        $('.DateValid').attr("aria-invalid", "false");
                        $('.DateValid').closest('.form-group').removeClass('has-error');
                    }
                }
            });
        }

    </script>
}

<style>
    #TotalHour {
        font-size: 15pt;
        font-weight: bold;
        float: left;
        background: #7ab4b3;
        color: #fff;
        padding: 5px 10px;
        margin-top: 5px;
        border-radius: 5px !important;
    }

    .datelabel {
        background: #4480ac;
        color: #fff;
        padding: 3px 1px;
        text-align: center;
        width: 100%;
        overflow: hidden;
        margin: 0;
    }

    .daylabel {
        color: #7e7e7e;
        text-align: center;
        width: 100%;
        overflow: hidden;
        margin: 0;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .numeric {
        text-align: right;
    }
</style>